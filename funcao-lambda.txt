export const handler = async (event) => {
  try {
    const record = event?.Records?.[0];
    const cf = record?.cf;
    const request = cf?.request;

    console.log('Lambda@Edge Triggered');
    console.log('Full event:', JSON.stringify(event));
    console.log('Request object:', JSON.stringify(request));

    // Se não houver request ou uri, redireciona para /index.html
    if (!request || typeof request.uri !== 'string') {
      console.log('URI ausente ou inválida. Redirecionando para /index.html');
      return {
        ...request,
        uri: '/index.html',
      };
    }

    const uri = request.uri;

    // Redireciona "/" para "/index.html"
    if (uri === '/') {
      request.uri = '/index.html';
    }

    // Reescreve caminhos que não começam com "/Arquivos/"
    else if (uri.length > 0 && uri.indexOf('/Arquivos/') !== 0) {
      request.uri = `/Arquivos${uri}`;
    }

    return request;
  } catch (error) {
    console.log('Erro na função Lambda@Edge:', error);

    // Fallback seguro: retorna o request original com uri ajustado
    return {
      uri: '/index.html',
      method: 'GET',
      headers: {},
      querystring: '',
    };
  }
};
